#!/usr/bin/env node

var Rollback = require('../'),
    grunt    = require('grunt'),
    fs       = require('fs'),
    config   = require('../conf/config'),
    path     = require('path'),
    commands = require('../conf/commands'),
    msg      = require('../conf/messages');

var lastSuccess,
    arguments   = process.argv.splice(2);

// Instantiate rollback
var rollback = new Rollback();

if(grunt.file.isDir(config.ROLLBACK)) {
  if(grunt.file.exists(config.ROLLBACK,
      config.LAST_SUCCESS)) {
    lastSuccess =
      grunt.file.read(path.join(process.cwd(), config.ROLLBACK,
        config.LAST_SUCCESS));
    rollback.setLastSuccess(lastSuccess);
  }
}

switch(arguments[0]) {
  case 'try':
    rollback[arguments[0]](arguments[1]);
    break;
  case 'build':
    rollback[arguments[0]](arguments[1]);
    break;
  case 'stop':
    rollback.closeServer(function() {});
    break;
  case 'current':
    if(!grunt.file.exist(path.join(process.cwd(), '.rollback'))) {
      grunt.log.error(msg.YOU_NEED_TO_BE_IN_A_ROLLBACK_FOLDER);
    } else if(!grunt.file.exist(path.join(process.cwd(), '.rollback', conf.LAST_SUCCESS)) {
      grunt.log.error(msg.THERE_IS_NO_INSTANCES_STARTED);
    } else {
      grunt.log.ok(rollback.getLastSuccess());
    }
    break;
  case '-v':
    var pjson = require('../package.json');
    console.log(pjson.version);
    break;
  default:
    break;
};
